<div class="container">
  <h1 class="page-title">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>

  <%= link_to "‡πÄ‡∏û‡∏¥‡πà‡∏°", reports_new_path %>

  <!-- Tabs -->
  <div class="tabs">
    <%= link_to "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô", reports_index_path(tab: "reports"), class: "tab #{params[:tab] != 'projects' ? 'active' : ''}" %>
    <%= link_to "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤", reports_index_path(tab: "projects"), class: "tab #{params[:tab] == 'projects' ? 'active' : ''}" %>
  </div>

  <!-- Search & Filter -->
  <div class="search-filter">
    <div class="search-wrapper">
      <svg class="search-report-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#7a7a7a" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
      <input type="text" placeholder="Search" class="search-input">
    </div>
    <%= button("Filters", type: :secondary , icon: raw('<svg style="width: 1rem; height: 1rem; margin-right: 0.75rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>')) %>
  </div>

  <!-- Main Content -->
  <% if params[:tab] == 'projects' %>
  <!-- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
          <th>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</th>
          <th>‡∏õ‡∏µ</th>
          <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @records.each do |project| %>
          <tr>
            <td><%= project.title %></td>
            <td><%= project.student_name %></td>
            <td><%= project.year %></td>
            <td><%= project.category %></td>
            <td>
  <% if project.respond_to?(:file) && project.file.attached? %>
    <% ext = File.extname(project.file.filename.to_s).delete('.').downcase %>
    <% type = if %w[jpg jpeg png gif].include?(ext)
                "image"
              elsif %w[mp4 mov avi].include?(ext)
                "video"
              elsif ext == "pdf"
                "pdf"
              else
                "other"
              end %>

    <% if type != "other" %>
      <button class="btn btn-secondary btn-preview"
        data-type="<%= type %>"
        data-url="<%= rails_blob_path(project.file, disposition: "inline") %>">
        ‡∏î‡∏π
      </button>
    <% else %>
      <%= button("‡∏î‡∏π", type: :secondary, disabled: true) %>
    <% end %>
  <% else %>
    <%= button("‡∏î‡∏π", type: :secondary, disabled: true) %>
  <% end %>
</td>

          </tr>
        <% end %>
      </tbody>
    </table>

    <%= render partial: "shared/pagination", locals: { records: @records, label: "projects" } %>
  </div>
  <% else %>
  <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @records.each do |report| %>
          <tr>
            <td>
              <span class="file-icon">
                <%= case File.extname(report.file.filename.to_s).downcase
                  when ".jpg", ".jpeg", ".png", ".gif"
                    "üì∑"
                  when ".mp4", ".mov", ".avi"
                    "üé•"
                  when ".pdf"
                    "üìÑ"
                  when ".doc", ".docx"
                    "üìù"
                  else
                    "üìÅ"
                end %>
              </span>
              <%= report.file.filename %>
            </td>
            <td class="col-btn">
              <% if report.file.attached? %>
                  <% ext = File.extname(report.file.filename.to_s).delete('.').downcase %>
                  <% type = if %w[jpg jpeg png gif].include?(ext)
                              "image"
                            elsif %w[mp4 mov avi].include?(ext)
                              "video"
                            elsif ext == "pdf"
                              "pdf"
                            else
                              "other"
                            end %>

                  <% if type != "other" %>
                    <button class="btn btn-secondary btn-preview"
                      data-type="<%= type %>"
                      data-url="<%= rails_blob_path(report.file, disposition: "inline") %>">
                      ‡∏î‡∏π
                    </button>
                  <% else %>
                    <%= button("‡∏î‡∏π", type: :secondary, disabled: true) %>
                  <% end %>
                <% end %>
                <%= link_to "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î", rails_blob_path(report.file, disposition: "attachment"), class: "btn btn-primary" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <%= render partial: "shared/pagination", locals: { records: @records, label: "reports" } %>
  </div>
  <% end %>

</div>
<!-- Modal -->
<div id="previewModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <div id="modalBody">
      <!-- ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏™‡πà image/video/pdf -->
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("previewModal");
  const closeModal = document.getElementById("closeModal");
  const modalBody = document.getElementById("modalBody");

  document.querySelectorAll(".btn-preview").forEach(button => {
    button.addEventListener("click", () => {
      const type = button.dataset.type;
      const url = button.dataset.url;
      modalBody.innerHTML = ""; // clear

      if (type === "image") {
        modalBody.innerHTML = `<img src="${url}" class="img-fluid" />`;
      } else if (type === "video") {
        modalBody.innerHTML = `<video src="${url}" controls style="width: 100%;"></video>`;
      } else if (type === "pdf") {
        modalBody.innerHTML = `<iframe src="${url}" width="100%" height="600px"></iframe>`;
      }

      modal.style.display = "block";
    });
  });

  closeModal.onclick = () => modal.style.display = "none";
  window.onclick = event => {
    if (event.target == modal) modal.style.display = "none";
  };
});

</script>