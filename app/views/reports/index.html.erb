<div class="container">
  <h1 class="page-title">รูปแบบรายงาน</h1>
  <% if current_user.role.name == "ผู้ดูแลระบบ" %>
    <%= link_to "เพิ่ม", reports_new_path %>
  <% end %>
  <!-- Tabs -->
  <div class="tabs">
    <%= link_to "รายงาน", reports_index_path(tab: "reports"), class: "tab #{params[:tab] != 'projects' ? 'active' : ''}" %>
    <%= link_to "โครงการที่ผ่านมา", reports_index_path(tab: "projects"), class: "tab #{params[:tab] == 'projects' ? 'active' : ''}" %>
  </div>

  <!-- Search & Filter -->
  <div class="search-filter">
    <div class="search-wrapper">
      <svg class="search-report-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#7a7a7a" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
      <input type="text" placeholder="Search" class="search-input">
    </div>
    <%= button("Filters", type: :secondary , icon: raw('<svg style="width: 1rem; height: 1rem; margin-right: 0.75rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>')) %>
  </div>

  <!-- Main Content -->
  <div class="report-grid">
  <% @records.each do |report| %>
    <div class="report-card-item">
      <div class="report-content">
        <p class="report-title ellipsis-one-line"><%= report.title %></p>
        <% if params[:tab] == "projects" %>
          <p class="report-meta">ปีการศึกษา: <%= report.year %></p>
          <p class="report-meta">ผู้จัดทำ: <%= report.student_name %></p>
          <p class="report-meta">หมวดหมู่: <%= report.category %></p>
        <% else %>
          <p class="report-meta">รายละเอียด: <%= report.category %></p>
        <% end %>

        <div class="report-actions">
          <%= link_to "ดู", "#", 
      class: "btn btn-secondary btn-preview", 
      data: {
        type: report.file.image? ? "image" : report.file.content_type.include?("pdf") ? "pdf" : "video",
        url: rails_blob_path(report.file, disposition: "inline")
      } %>
          <% if params[:tab] != "projects" %>
          <%= link_to "ดาวน์โหลด", rails_blob_path(report.file, disposition: "attachment"), class: "btn btn-primary" %>
          <% end %>
          <% if current_user.role.name == "ผู้ดูแลระบบ" %>
            <%= link_to "แก้ไข", edit_report_path(report), class: "btn btn-warning" %>
            <%= button_to "ลบ", delete_report_path(report), method: :delete, data: { confirm: "แน่ใจหรือไม่?" }, class: "btn btn-danger" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
</div>
<!-- Modal -->
<div id="previewModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <div id="modalBody">
      <!-- ตรงนี้จะใส่ image/video/pdf -->
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("previewModal");
  const closeModal = document.getElementById("closeModal");
  const modalBody = document.getElementById("modalBody");

  document.querySelectorAll(".btn-preview").forEach(button => {
    button.addEventListener("click", () => {
      const type = button.dataset.type;
      const url = button.dataset.url;
      modalBody.innerHTML = ""; // clear

      if (type === "image") {
        modalBody.innerHTML = `<img src="${url}" class="img-fluid" />`;
      } else if (type === "video") {
        modalBody.innerHTML = `<video src="${url}" controls style="width: 100%;"></video>`;
      } else if (type === "pdf") {
        modalBody.innerHTML = `<iframe src="${url}" width="100%" height="600px"></iframe>`;
      }

      modal.style.display = "block";
    });
  });

  closeModal.onclick = () => modal.style.display = "none";
  window.onclick = event => {
    if (event.target == modal) modal.style.display = "none";
  };
});

</script>